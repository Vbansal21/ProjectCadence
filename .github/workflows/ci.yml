name: CI

on:
  push:
    branches: [main, develop, "feature/**", "release/**", "hotfix/**"]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  precommit:
    name: Pre-commit (lint/format)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit
      - name: Run pre-commit on all files
        run: pre-commit run --all-files

  codeql:
    name: CodeQL (C/C++)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: cpp
      - name: Build C/C++ for CodeQL (Week 1)
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build g++
          cmake -S weeks/W01_20250804_reverse-stdlib -B build-w01 -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build-w01 --parallel
      - uses: github/codeql-action/analyze@v3

  week1-tests:
    name: Build & test Week 1 (CMake + CTest) ${{ matrix.compiler }} ${{ matrix.config }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
        config: [Release, ASan]
    steps:
      - uses: actions/checkout@v4

      - name: Locate Week 1 directory
        id: w1
        shell: bash
        run: |
          W1=$(ls -d weeks/W01_* 2>/dev/null | head -n1 || true)
          echo "dir=$W1" >> "$GITHUB_OUTPUT"
          if [ -z "$W1" ]; then echo "No Week 1 dir found; will skip."; fi

      - name: Toolchain + ccache
        if: ${{ steps.w1.outputs.dir != '' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build g++ clang ccache
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            echo 'CC=ccache gcc'   >> $GITHUB_ENV
            echo 'CXX=ccache g++'  >> $GITHUB_ENV
          else
            echo 'CC=ccache clang'   >> $GITHUB_ENV
            echo 'CXX=ccache clang++'>> $GITHUB_ENV
          fi
          # make ccache a bit more effective
          ccache --set-config=max_size=256M || true

      - name: Cache ccache (W01)
        if: ${{ steps.w1.outputs.dir != '' }}
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-w01-${{ runner.os }}-${{ matrix.compiler }}-${{ matrix.config }}-${{ hashFiles('weeks/W01_20250804_reverse-stdlib/**', '.github/workflows/ci.yml') }}
          restore-keys: |
            ccache-w01-${{ runner.os }}-${{ matrix.compiler }}-
            ccache-w01-${{ runner.os }}-

      - name: Cache CMake build dir (W01)
        if: ${{ steps.w1.outputs.dir != '' }}
        uses: actions/cache@v4
        with:
          path: build-w01
          key: cmake-w01-${{ runner.os }}-${{ matrix.compiler }}-${{ matrix.config }}-${{ hashFiles('weeks/W01_20250804_reverse-stdlib/**', '.github/workflows/ci.yml') }}
          restore-keys: |
            cmake-w01-${{ runner.os }}-${{ matrix.compiler }}-
            cmake-w01-${{ runner.os }}-

      - name: Configure (W01)
        if: ${{ steps.w1.outputs.dir != '' }}
        run: |
          EXTRA=""
          if [ "${{ matrix.config }}" = "ASan" ]; then
            EXTRA="-DW01_ENABLE_ASAN=ON"
          fi
          cmake -S "${{ steps.w1.outputs.dir }}" -B build-w01 -G Ninja -DCMAKE_BUILD_TYPE=Release $EXTRA

      - name: Build (W01)
        if: ${{ steps.w1.outputs.dir != '' }}
        run: cmake --build build-w01 --parallel

      - name: Test (W01)
        if: ${{ steps.w1.outputs.dir != '' }}
        run: ctest --test-dir build-w01 --output-on-failure

      - name: CTest with XML
        if: ${{ steps.w1.outputs.dir != '' }}
        run: |
          ctest --test-dir build-w01 --output-on-failure -T Test --no-compress-output || true
          mkdir -p test-results
          if [ -f build-w01/Testing/Temporary/LastTest.log ]; then
            cp build-w01/Testing/Temporary/LastTest.log test-results/last-test.log
          fi
          if [ -f build-w01/Testing/Temporary/LastTestsFailed.log ]; then
            cp build-w01/Testing/Temporary/LastTestsFailed.log test-results/last-tests-failed.log
          fi
          if [ -f build-w01/Testing/Temporary/LastTestsPassed.log ]; then
            cp build-w01/Testing/Temporary/LastTestsPassed.log test-results/last-tests-passed.log
          fi

      - name: Upload CTest reports
        if: ${{ steps.w1.outputs.dir != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: w01-ctest-${{ matrix.compiler }}-${{ matrix.config }}
          path: |
            build-w01/Testing/**/*
            test-results/*
          if-no-files-found: warn

      - name: Skip Week 1 (no directory)
        if: ${{ steps.w1.outputs.dir == '' }}
        run: |
          echo "Skipping Week 1: directory not present."

  week2-build:
    name: Build Week 2 (bench compiles)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Locate Week 2 directory
        id: w2
        shell: bash
        run: |
          W2=$(ls -d weeks/W02_* 2>/dev/null | head -n1 || true)
          echo "dir=$W2" >> "$GITHUB_OUTPUT"
          if [ -z "$W2" ]; then echo "No Week 2 dir found; will skip."; fi

      - name: Toolchain + ccache
        if: ${{ steps.w2.outputs.dir != '' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build g++ ccache
          echo 'CC=ccache gcc'  >> $GITHUB_ENV
          echo 'CXX=ccache g++' >> $GITHUB_ENV
          ccache --set-config=max_size=256M || true

      - name: Cache ccache (W02)
        if: ${{ steps.w2.outputs.dir != '' }}
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ccache-w02-${{ runner.os }}-${{ hashFiles('weeks/W02_20250811_dsa-benchmarks/**', '.github/workflows/ci.yml') }}
          restore-keys: |
            ccache-w02-${{ runner.os }}-

      - name: Cache CMake build dir (W02)
        if: ${{ steps.w2.outputs.dir != '' }}
        uses: actions/cache@v4
        with:
          path: build-w02
          key: cmake-w02-${{ runner.os }}-${{ hashFiles('weeks/W02_20250811_dsa-benchmarks/**', '.github/workflows/ci.yml') }}
          restore-keys: |
            cmake-w02-${{ runner.os }}-

      - name: Configure (W02)
        if: ${{ steps.w2.outputs.dir != '' }}
        run: cmake -S "${{ steps.w2.outputs.dir }}" -B build-w02 -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build (W02)
        if: ${{ steps.w2.outputs.dir != '' }}
        run: cmake --build build-w02 --parallel

      - name: Optional smoke run (60s cap)
        if: ${{ steps.w2.outputs.dir != '' }}
        run: |
          if [ -x build-w02/bench ]; then
            out=bench.out
            timeout 60s ./build-w02/bench > "$out" 2>&1 || true
            tail -n 80 "$out" || true
          else
            echo "No bench binary; skip run."
          fi

      - name: Upload bench log (optional)
        if: ${{ steps.w2.outputs.dir != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: w02-bench-log
          path: bench.out
          if-no-files-found: ignore

      - name: Skip Week 2 (no directory)
        if: ${{ steps.w2.outputs.dir == '' }}
        run: |
          echo "Skipping Week 2: directory not present."
